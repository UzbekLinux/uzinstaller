#!/usr/bin/env python3
import sys
import json
import subprocess
from pathlib import Path

from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QMessageBox,
    QStackedWidget, QButtonGroup
)
from PyQt6.QtGui import (
    QIcon
)
from PyQt6.QtCore import QProcess, pyqtSlot, Qt, QSize
from PyQt6.QtWidgets import QMainWindow

from start import Ui_MainWindow as StartUI
from overview import Ui_MainWindow as OverviewUI
from part import Ui_MainWindow as PartUI
from user import Ui_MainWindow as UserUI
from install import Ui_MainWindow as InstallUI

CONFIG_PATH = Path("/tmp/uzbekinstall.conf")
INSTALL_SCRIPT = "/tmp/uzbekinstall.sh"

class StartPage(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = StartUI()
        self.ui.setupUi(self)

class OverviewPage(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = OverviewUI()
        self.ui.setupUi(self)

class PartPage(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = PartUI()
        self.ui.setupUi(self)

        self.group = QButtonGroup(self)
        self.group.addButton(self.ui.radioButton)
        self.group.addButton(self.ui.radioButton_2)

        self.load_auto_disks()
        self.load_manual_partitions()
        
        self.ui.radioButton.toggled.connect(self.update_state)
        self.ui.radioButton_2.toggled.connect(self.update_state)
        self.ui.pushButton_2.clicked.connect(self.open_gparted)
        
        self.ui.radioButton.setChecked(True)
        
        self.update_state()

    def get_lsblk_names(self):
        out = subprocess.check_output(
            ["lsblk", "-J", "-o", "NAME"],
            text=True
        )
        return json.loads(out)["blockdevices"]

    def update_state(self):
        auto = self.ui.radioButton.isChecked()

        self.ui.label_4.setEnabled(auto)
        self.ui.comboBox.setEnabled(auto)

        for w in (
            self.ui.label_5, self.ui.label_6,
            self.ui.comboBox_2, self.ui.comboBox_3
        ):
            w.setEnabled(not auto)

    def open_gparted(self):
        subprocess.Popen(["gparted"])

    def load_auto_disks(self):
        self.ui.comboBox.clear()
    
        for dev in self.get_lsblk_names():
            name = dev["name"]
            path = "/dev/" + name
            self.ui.comboBox.addItem(path, path)

    def load_manual_partitions(self):
        self.ui.comboBox_2.clear()
        self.ui.comboBox_3.clear()
    
        for dev in self.get_lsblk_names():
            for part in dev.get("children", []):
                path = "/dev/" + part["name"]
                self.ui.comboBox_2.addItem(path, path)
                self.ui.comboBox_3.addItem(path, path)
    
    def validate(self):
        if not self.group.checkedButton():
            return False, "ты не выбрать свой разметка. мы не угадатад."

        if self.ui.radioButton.isChecked():
            if not self.ui.comboBox.currentText():
                return False, "выбери диск для UzbekPartitions™ сука"
        else:
            if not self.ui.comboBox_2.currentText() or not self.ui.comboBox_3.currentText():
                return False, "root и efi разделы сами себя не выберут"

        return True, ""

    def collect(self):
        if self.ui.radioButton.isChecked():
            return {
                "PART_MODE": "auto",
                "DISK": self.ui.comboBox.currentText(),
            }
        return {
            "PART_MODE": "manual",
            "ROOT_PART": self.ui.comboBox_2.currentText(),
            "EFI_PART": self.ui.comboBox_3.currentText(),
        }


class UserPage(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = UserUI()
        self.ui.setupUi(self)

    def validate(self):
        fields = [
            self.ui.lineEdit_2.text(),
            self.ui.lineEdit_3.text(),
            self.ui.lineEdit.text(),
            self.ui.lineEdit_4.text(),
        ]
        if not all(fields):
            return False, "Заполни всё. Da, ВСЁ"
        return True, ""

    def collect(self):
        return {
            "HOSTNAME": self.ui.lineEdit_2.text(),
            "USERNAME": self.ui.lineEdit_3.text(),
            "USER_PASSWORD": self.ui.lineEdit.text(),
            "ROOT_PASSWORD": self.ui.lineEdit_4.text(),
        }


class InstallPage(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = InstallUI()
        self.ui.setupUi(self)

        self.process = QProcess(self)
        self.process.readyReadStandardOutput.connect(self.read_output)
        self.process.readyReadStandardError.connect(self.read_output)
        self.process.finished.connect(self.finished)

        self.ui.pushButton.clicked.connect(self.reboot)
        self.ui.pushButton_2.clicked.connect(QApplication.quit)

    def start_install(self):
        self.process.start("sh", [INSTALL_SCRIPT])

    def read_output(self):
        text = self.process.readAllStandardOutput().data().decode()
        text += self.process.readAllStandardError().data().decode()
        self.ui.textEdit.append(text)

    def finished(self, exitCode, exitStatus):
            self.ui.pushButton.setEnabled(True)
            self.ui.pushButton_2.setEnabled(True)
        
            if exitStatus == QProcess.ExitStatus.NormalExit and exitCode == 0:
            
                QMessageBox.information(
                    self,
                    "Готово",
                    "ХОРОШ СУКА СИСТЕМА УСТАНОВЛЕНА СУКА DA."
                )
            else:
                QMessageBox.critical(
                    self,
                    "Ошибка",
                    f"ээ тут ошибка произошла!! (код {exitCode})"
                )
        

    def reboot(self):
        subprocess.call(["reboot"])

class Installer(QMainWindow):
    def __init__(self):
        super().__init__()

        icon = QIcon("/usr/local/bin/uzinstaller/2705.png")
        self.setWindowIcon(icon)
        
        self.stack = QStackedWidget()
        self.setCentralWidget(self.stack)

        self.setWindowTitle("Установка Uzbek Linux")
        
        self.setFixedSize(807, 453)
        
        self.data = {}

        self.start = StartPage()
        self.overview = OverviewPage()
        self.part = PartPage()
        self.user = UserPage()
        self.install = InstallPage()

        self.start_page = self.start.centralWidget()
        self.overview_page = self.overview.centralWidget()
        self.part_page = self.part.centralWidget()
        self.user_page = self.user.centralWidget()
        self.install_page = self.install.centralWidget()
        
        self.stack.addWidget(self.start_page)
        self.stack.addWidget(self.overview_page)
        self.stack.addWidget(self.part_page)
        self.stack.addWidget(self.user_page)
        self.stack.addWidget(self.install_page)

        self.start.ui.pushButton.clicked.connect(self.next_from_start)
        self.overview.ui.pushButton.clicked.connect(self.next_from_overview)
        self.part.ui.pushButton.clicked.connect(self.next_from_part)
        self.user.ui.pushButton.clicked.connect(self.next_from_user)

    def next_from_start(self):
        self.stack.setCurrentWidget(self.overview_page)

    def next_from_overview(self):
        self.stack.setCurrentWidget(self.part_page)

    def next_from_part(self):
        ok, msg = self.part.validate()
        if not ok:
            QMessageBox.warning(self, "Ошибка", msg)
            return
        self.data.update(self.part.collect())
        self.stack.setCurrentWidget(self.user_page)

    def next_from_user(self):
        ok, msg = self.user.validate()
        if not ok:
            QMessageBox.warning(self, "Ошибка", msg)
            return
        self.data.update(self.user.collect())
        self.write_config()
        self.stack.setCurrentWidget(self.install_page)
        self.install.start_install()

    def write_config(self):
        with open(CONFIG_PATH, "w") as f:
            for k, v in self.data.items():
                f.write(f'{k}="{v}"\n')

if __name__ == "__main__":
    app = QApplication(sys.argv)
    w = Installer()
    w.show()
    sys.exit(app.exec())
