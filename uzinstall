#!/usr/bin/env python3
import os
import sys
import json
import subprocess
from pathlib import Path

from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QMessageBox,
    QStackedWidget, QButtonGroup
)
from PyQt6.QtGui import (
    QIcon
)
from PyQt6.QtCore import QProcess, pyqtSlot, Qt, QSize
from PyQt6.QtWidgets import QMainWindow

from start import Ui_MainWindow as StartUI
from overview import Ui_MainWindow as OverviewUI
from system import Ui_MainWindow as SystemUI
from user import Ui_MainWindow as UserUI
from install import Ui_MainWindow as InstallUI

CONFIG_PATH = Path("/tmp/uzbekinstall.conf")
INSTALL_SCRIPT = "/tmp/uzbekinstall.sh"

class StartPage(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = StartUI()
        self.ui.setupUi(self)

class OverviewPage(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = OverviewUI()
        self.ui.setupUi(self)

class SystemPage(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = SystemUI()
        self.ui.setupUi(self)

        self.group = QButtonGroup(self)
        self.group.addButton(self.ui.auto_RadioButton)
        self.group.addButton(self.ui.manual_RadioButton)

        self.load_auto_disks()
        self.load_manual_partitions()
        self.load_bl_and_dm()
        
        self.ui.auto_RadioButton.toggled.connect(self.update_state)
        self.ui.manual_RadioButton.toggled.connect(self.update_state)
        self.ui.pushButton_next_2.clicked.connect(self.open_gparted)
        
        self.ui.auto_RadioButton.setChecked(True)
        
        self.update_state()

    def get_lsblk_names(self):
        out = subprocess.check_output(
            ["lsblk", "-J", "-o", "NAME"],
            text=True
        )
        return json.loads(out)["blockdevices"]

    def update_state(self):
        auto = self.ui.auto_RadioButton.isChecked()

        # self.ui.label_4.setEnabled(auto)
        self.ui.Auto_Disk_comboBox.setEnabled(auto)

        for w in (
            self.ui.manual_root_ComboBox, self.ui.manual_boot_comboBox
        ):
            w.setEnabled(not auto)

    def open_gparted(self):
        subprocess.Popen(["gparted"])

    def load_auto_disks(self):
        self.ui.Auto_Disk_comboBox.clear()
    
        for dev in self.get_lsblk_names():
            name = dev["name"]
            path = "/dev/" + name
            self.ui.Auto_Disk_comboBox.addItem(path, path)

    def load_bl_and_dm(self):
        self.ui.bootloader_comboBox.clear()
        self.ui.displayManager_comboBox.clear()
    
        DISPLAY_MANAGERS = ["LightDM", "SDDM"]
        BIOS_BOOTLOADERS = ["GRUB"]
        UEFI_BOOTLOADERS = ["GRUB", "Limine", "rEFInd", "systemd-boot"]

        UEFI = os.path.exists("/sys/firmware/efi")

        if UEFI:
            for bl in UEFI_BOOTLOADERS:
                self.ui.bootloader_comboBox.addItem(bl, bl)
        else:
            for bl in BIOS_BOOTLOADERS:
                self.ui.bootloader_comboBox.addItem(bl, bl)

        for dm in DISPLAY_MANAGERS:
            self.ui.displayManager_comboBox.addItem(dm, dm)
                
        
    def load_manual_partitions(self):
        self.ui.manual_root_ComboBox.clear()
        self.ui.manual_boot_comboBox.clear()
    
        for dev in self.get_lsblk_names():
            for part in dev.get("children", []):
                path = "/dev/" + part["name"]
                self.ui.manual_root_ComboBox.addItem(path, path)
                self.ui.manual_boot_comboBox.addItem(path, path)
    
    def validate(self):
        if not self.group.checkedButton():
            return False, "ты не выбрать свой разметка. мы не угадатад."

        if self.ui.auto_RadioButton.isChecked():
            if not self.ui.Auto_Disk_comboBox.currentText():
                return False, "выбери диск для UzbekPartitions™ сука"
        else:
            if not self.ui.manual_root_ComboBox.currentText() or not self.ui.manual_boot_comboBox.currentText():
                return False, "root и efi разделы сами себя не выберут"

        return True, ""

    def collect(self):
        if self.ui.auto_RadioButton.isChecked():
            return {
                "PART_MODE": "auto",
                "DISK": self.ui.Auto_Disk_comboBox.currentText(),
                "DM": self.ui.displayManager_comboBox.currentText(),
                "BOOTLOADER": self.ui.bootloader_comboBox.currentText()
            }
        return {
            "PART_MODE": "manual",
            "ROOT_PART": self.ui.manual_root_ComboBox.currentText(),
            "EFI_PART": self.ui.manual_boot_ComboBox.currentText(),
            "DM": self.ui.displayManager_comboBox.currentText(),
            "BOOTLOADER": self.ui.bootloader_comboBox.currentText()
        }


class UserPage(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = UserUI()
        self.ui.setupUi(self)

    def validate(self):
        fields = [
            self.ui.UserNameEdit.text(),
            self.ui.HostNameEdit.text(),
            self.ui.UserPassWordEdit.text(),
            self.ui.RootPassWordEdit.text(),
        ]
        if not all(fields):
            return False, "Заполни всё. Da, ВСЁ"
        return True, ""

    def collect(self):
        return {
            "HOSTNAME": self.ui.HostNameEdit.text(),
            "USERNAME": self.ui.UserNameEdit.text(),
            "USER_PASSWORD": self.ui.UserPassWordEdit.text(),
            "ROOT_PASSWORD": self.ui.RootPassWordEdit.text(),
        }
        

class InstallPage(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = InstallUI()
        self.ui.setupUi(self)

        self.process = QProcess(self)
        self.process.readyReadStandardOutput.connect(self.read_output)
        self.process.readyReadStandardError.connect(self.read_output)
        self.process.finished.connect(self.finished)

        self.ui.pushButton_reboot.clicked.connect(self.reboot)
        self.ui.pushButton_next.clicked.connect(QApplication.quit)

    def start_install(self):
        self.process.start("sh", [INSTALL_SCRIPT])

    def read_output(self):
        text = self.process.readAllStandardOutput().data().decode()
        text += self.process.readAllStandardError().data().decode()
        self.ui.terminalView.append(text)

    def finished(self, exitCode, exitStatus):
            self.ui.pushButton_reboot.setEnabled(True)
            self.ui.pushButton_next.setEnabled(True)
        
            if exitStatus == QProcess.ExitStatus.NormalExit and exitCode == 0:
            
                QMessageBox.information(
                    self,
                    "Готово",
                    "ХОРОШ СУКА СИСТЕМА УСТАНОВЛЕНА СУКА DA."
                )
            else:
                QMessageBox.critical(
                    self,
                    "Ошибка",
                    f"ээ тут ошибка произошла!! (код {exitCode})"
                )
        

    def reboot(self):
        subprocess.call(["reboot"])

class Installer(QMainWindow):
    def __init__(self):
        super().__init__()

        icon = QIcon("/usr/local/bin/uzinstaller/2705.png")
        self.setWindowIcon(icon)
        
        self.stack = QStackedWidget()
        self.setCentralWidget(self.stack)

        self.setWindowTitle("Установка Uzbek Linux")
        
        self.setFixedSize(831, 619)
        
        self.data = {}

        self.start = StartPage()
        self.overview = OverviewPage()
        self.system = SystemPage()
        self.user = UserPage()
        self.install = InstallPage()

        self.start_page = self.start.centralWidget()
        self.overview_page = self.overview.centralWidget()
        self.system_page = self.system.centralWidget()
        self.user_page = self.user.centralWidget()
        self.install_page = self.install.centralWidget()
        
        self.stack.addWidget(self.start_page)
        self.stack.addWidget(self.overview_page)
        self.stack.addWidget(self.system_page)
        self.stack.addWidget(self.user_page)
        self.stack.addWidget(self.install_page)

        self.start.ui.pushButton_next.clicked.connect(self.next_from_start)
        self.overview.ui.pushButton_next.clicked.connect(self.next_from_overview)
        self.system.ui.pushButton_next.clicked.connect(self.next_from_system)
        self.user.ui.pushButton_next.clicked.connect(self.next_from_user)
        

    def next_from_start(self):
        self.stack.setCurrentWidget(self.overview_page)

    def next_from_overview(self):
        self.stack.setCurrentWidget(self.system_page)

    def next_from_system(self):
        ok, msg = self.system.validate()
        if not ok:
            QMessageBox.warning(self, "Ошибка", msg)
            return
        self.data.update(self.system.collect())
        self.stack.setCurrentWidget(self.user_page)

    def next_from_user(self):
        ok, msg = self.user.validate()
        if not ok:
            QMessageBox.warning(self, "Ошибка", msg)
            return
        self.data.update(self.user.collect())
        self.write_config()
        self.stack.setCurrentWidget(self.install_page)
        self.install.start_install()

    def write_config(self):
        with open(CONFIG_PATH, "w") as f:
            for k, v in self.data.items():
                print(k,v)
                f.write(f'{k}="{v}"\n')

if __name__ == "__main__":
    app = QApplication(sys.argv)
    w = Installer()
    w.show()
    sys.exit(app.exec())
